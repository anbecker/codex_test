# Agent Guidelines for Poetry Assistant

## Project overview
- **Purpose:** Command-line assistant that builds a SQLite-backed lexicon for poets and lyricists, exposed through the `poetry-assistant` CLI.
- **Key directories:**
  - `src/poetry_assistant/`: Core Python package (CLI entry point in `cli.py`, ingestion pipeline in `ingest.py`, database access in `database.py`, rhyme/search logic in `rhymes.py`, `search.py`, and helpers).
  - `tests/`: Pytest suites that cover ingestion, search, and rhyme features.
  - `docs/`: Supplemental user and pattern guides referenced by the README.
- **Primary entry points:** `pyproject.toml` defines the `poetry-assistant` console script; `src/poetry_assistant/__init__.py` exposes package metadata.

## Safe code modification rules
- Work in small, well-scoped commits; keep diffs minimal and focused on a single concern.
- Always run the relevant automated tests before committing, and document the command in your report.
- Use descriptive commit messages in the form `type: summary` (e.g., `fix: correct rhyme scoring`).
- Never force-push or rewrite shared history; prefer new commits for revisions.

## File access guidelines
- **Read/Write:** Source files under `src/`, tests under `tests/`, configuration in `pyproject.toml`, and documentation in `README.md` and `docs/`.
- **Read-only unless instructed:** Generated data files, virtual environments, or large external corpora (do not download CMU/WordNet data during tests unless required).
- **Avoid modifying:** Build artifacts, cache directories, and dependency metadata generated by tools unless you are intentionally updating them.

## Documentation updates
- Update `README.md` when user-facing behaviour, CLI options, or installation steps change.
- Maintain `docs/` guides when altering their referenced features or syntax (e.g., syllable pattern semantics).
- Revise or add docstrings alongside code changes that affect public APIs.
- Record notable user-facing fixes or features in `CHANGELOG.md` if present; otherwise mention them in the PR summary.

## Dependency management
- Dependencies live in `pyproject.toml`. Modify `[project]` and optional extras sections as needed.
- When changing dependencies, regenerate any associated lock file (e.g., `poetry.lock`) using Poetry; include both manifest and lock updates in the same commit.
- Prefer the minimal necessary version bumps; note rationale in commit/PR descriptions.

## Coding conventions
- Follow Python 3.11+ best practices and the existing code style (PEP 8 compliant).
- Use `black` for formatting, `isort` for imports, and `ruff` or `flake8` for linting if configured in `pyproject.toml`.
- Name modules, functions, and variables descriptively; keep CLI commands snake_case.
- Add type hints where practical and maintain consistency with existing annotations.

## Testing requirements
- Run `pytest` from the repository root before committing changes that affect code or tests.
- Add or update tests in `tests/` for new features, bug fixes, or regressions.
- Treat test failures as blockers; investigate and resolve before submitting.

## Safety and rollback
- Before destructive operations (e.g., deleting files, migrations), confirm they are intentional and reviewed.
- If a change introduces regressions, use `git revert <commit>` to roll back cleanly rather than editing history.
- Keep backups of critical data paths (e.g., sample SQLite fixtures) and avoid committing large binaries.

## Collaboration etiquette
- Follow the `type: summary` commit message format and include context in the body when necessary.
- Pull requests should summarise the change, testing performed, and any follow-up work; request review before merging.
- Engage with reviewer feedback promptly and transparently; address comments via additional commits.

## Version control workflow
- `main` holds stable, releasable code. Create feature branches (`feature/<short-description>`) off `main` for work.
- Rebase or merge `main` regularly to stay up to date, resolving conflicts locally.
- Only fast-forward or merge feature branches after tests pass and reviews are complete.

## Example agent workflow
1. Detect that a dependency in `pyproject.toml` is outdated.
2. Create a feature branch (`feature/update-deps`), bump the version, and regenerate `poetry.lock`.
3. Run `pytest` and any linters configured in `pyproject.toml`.
4. Update `README.md` or `CHANGELOG.md` if the dependency change affects users.
5. Commit with `chore: update dependency xyz to 1.2.3` and push for review.
6. Open a PR summarising the change, tests run, and any follow-up considerations.
